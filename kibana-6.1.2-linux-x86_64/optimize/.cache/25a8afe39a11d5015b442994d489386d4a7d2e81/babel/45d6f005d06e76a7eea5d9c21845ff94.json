{"remainingRequest":"/home/vagrant/projects/kibana/build/kibana/node_modules/babel-loader/lib/index.js??ref--6-1!/home/vagrant/projects/kibana/build/kibana/src/ui/public/vis/agg_config.js","dependencies":[{"path":"/home/vagrant/projects/kibana/build/kibana/src/ui/public/vis/agg_config.js","mtime":1515552038000},{"path":"/home/vagrant/projects/kibana/build/kibana/node_modules/cache-loader/dist/cjs.js","mtime":1493198456000},{"path":"/home/vagrant/projects/kibana/build/kibana/node_modules/babel-loader/lib/index.js","mtime":1503096278000}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.VisAggConfigProvider = VisAggConfigProvider;\n\nvar _lodash = require('lodash');\n\nvar _lodash2 = _interopRequireDefault(_lodash);\n\nvar _field_formats = require('ui/registry/field_formats');\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\n/**\n * @name AggConfig\n *\n * @description This class represents an aggregation, which is displayed in the left-hand nav of\n * the Visualize app.\n */\n\nfunction VisAggConfigProvider(Private, Promise) {\n  var fieldFormats = Private(_field_formats.RegistryFieldFormatsProvider);\n\n  function AggConfig(vis, opts) {\n    var self = this;\n\n    self.id = String(opts.id || AggConfig.nextId(vis.aggs));\n    self.vis = vis;\n    self._opts = opts = opts || {};\n    self.enabled = typeof opts.enabled === 'boolean' ? opts.enabled : true;\n\n    // start with empty params so that checks in type/schema setters don't freak\n    // because self.params is undefined\n    self.params = {};\n\n    // setters\n    self.type = opts.type;\n    self.schema = opts.schema;\n\n    // set the params to the values from opts, or just to the defaults\n    self.setParams(opts.params || {});\n  }\n\n  /**\n   * Ensure that all of the objects in the list have ids, the objects\n   * and list are modified by reference.\n   *\n   * @param  {array[object]} list - a list of objects, objects can be anything really\n   * @return {array} - the list that was passed in\n   */\n  AggConfig.ensureIds = function (list) {\n    var have = [];\n    var haveNot = [];\n    list.forEach(function (obj) {\n      (obj.id ? have : haveNot).push(obj);\n    });\n\n    var nextId = AggConfig.nextId(have);\n    haveNot.forEach(function (obj) {\n      obj.id = String(nextId++);\n    });\n\n    return list;\n  };\n\n  /**\n   * Calculate the next id based on the ids in this list\n   *\n   * @return {array} list - a list of objects with id properties\n   */\n  AggConfig.nextId = function (list) {\n    return 1 + list.reduce(function (max, obj) {\n      return Math.max(max, +obj.id || 0);\n    }, 0);\n  };\n\n  Object.defineProperties(AggConfig.prototype, {\n    type: {\n      get: function get() {\n        return this.__type;\n      },\n      set: function set(type) {\n        if (this.__typeDecorations) {\n          _lodash2.default.forOwn(this.__typeDecorations, function (prop, name) {\n            delete this[name];\n          }, this);\n        }\n\n        if (_lodash2.default.isString(type)) {\n          type = AggConfig.aggTypes.byName[type];\n        }\n\n        if (type && _lodash2.default.isFunction(type.decorateAggConfig)) {\n          this.__typeDecorations = type.decorateAggConfig();\n          Object.defineProperties(this, this.__typeDecorations);\n        }\n\n        this.__type = type;\n\n        // clear out the previous params except for a few special ones\n        this.setParams({\n          // split row/columns is \"outside\" of the agg, so don't reset it\n          row: this.params.row,\n\n          // almost every agg has fields, so we try to persist that when type changes\n          field: _lodash2.default.get(this.getFieldOptions(), ['byName', this.getField()])\n        });\n      }\n    },\n    schema: {\n      get: function get() {\n        return this.__schema;\n      },\n      set: function set(schema) {\n        if (_lodash2.default.isString(schema)) {\n          schema = this.vis.type.schemas.all.byName[schema];\n        }\n\n        this.__schema = schema;\n      }\n    }\n  });\n\n  /**\n   * Write the current values to this.params, filling in the defaults as we go\n   *\n   * @param  {object} [from] - optional object to read values from,\n   *                         used when initializing\n   * @return {undefined}\n   */\n  AggConfig.prototype.setParams = function (from) {\n    var self = this;\n    from = from || self.params || {};\n    var to = self.params = {};\n\n    self.getAggParams().forEach(function (aggParam) {\n      var val = from[aggParam.name];\n\n      if (val == null) {\n        if (aggParam.default == null) return;\n\n        if (!_lodash2.default.isFunction(aggParam.default)) {\n          val = aggParam.default;\n        } else {\n          val = aggParam.default(self);\n          if (val == null) return;\n        }\n      }\n\n      if (aggParam.deserialize) {\n        var isTyped = _lodash2.default.isFunction(aggParam.type);\n\n        var isType = isTyped && val instanceof aggParam.type;\n        var isObject = !isTyped && _lodash2.default.isObject(val);\n        var isDeserialized = isType || isObject;\n\n        if (!isDeserialized) {\n          val = aggParam.deserialize(val, self);\n        }\n\n        to[aggParam.name] = val;\n        return;\n      }\n\n      to[aggParam.name] = _lodash2.default.cloneDeep(val);\n    });\n  };\n\n  AggConfig.prototype.write = function () {\n    return this.type.params.write(this);\n  };\n\n  AggConfig.prototype.isFilterable = function () {\n    return _lodash2.default.isFunction(this.type.createFilter);\n  };\n\n  AggConfig.prototype.createFilter = function (key) {\n    if (!this.isFilterable()) {\n      throw new TypeError('The \"' + this.type.title + '\" aggregation does not support filtering.');\n    }\n\n    var field = this.getField();\n    var label = this.getFieldDisplayName();\n    if (field && !field.filterable) {\n      var message = 'The \"' + label + '\" field can not be used for filtering.';\n      if (field.scripted) {\n        message = 'The \"' + label + '\" field is scripted and can not be used for filtering.';\n      }\n      throw new TypeError(message);\n    }\n\n    return this.type.createFilter(this, key);\n  };\n\n  /**\n   *  Hook for pre-flight logic, see AggType#onSearchRequestStart\n   *  @param {Courier.SearchSource} searchSource\n   *  @param {Courier.SearchRequest} searchRequest\n   *  @return {Promise<undefined>}\n   */\n  AggConfig.prototype.onSearchRequestStart = function (searchSource, searchRequest) {\n    var _this = this;\n\n    if (!this.type) {\n      return Promise.resolve();\n    }\n\n    return Promise.map(this.type.params, function (param) {\n      return param.modifyAggConfigOnSearchRequestStart(_this, searchSource, searchRequest);\n    });\n  };\n\n  /**\n   * Convert this aggConfig to its dsl syntax.\n   *\n   * Adds params and adhoc subaggs to a pojo, then returns it\n   *\n   * @param  {AggConfig} aggConfig - the config object to convert\n   * @return {void|Object} - if the config has a dsl representation, it is\n   *                         returned, else undefined is returned\n   */\n  AggConfig.prototype.toDsl = function () {\n    if (this.type.hasNoDsl) return;\n    var output = this.write();\n\n    var configDsl = {};\n    configDsl[this.type.dslName || this.type.name] = output.params;\n\n    // if the config requires subAggs, write them to the dsl as well\n    if (this.subAggs && !output.subAggs) output.subAggs = this.subAggs;\n    if (output.subAggs) {\n      var subDslLvl = configDsl.aggs || (configDsl.aggs = {});\n      output.subAggs.forEach(function nestAdhocSubAggs(subAggConfig) {\n        subDslLvl[subAggConfig.id] = subAggConfig.toDsl();\n      });\n    }\n\n    if (output.parentAggs) {\n      var _subDslLvl = configDsl.parentAggs || (configDsl.parentAggs = {});\n      output.parentAggs.forEach(function nestAdhocSubAggs(subAggConfig) {\n        _subDslLvl[subAggConfig.id] = subAggConfig.toDsl();\n      });\n    }\n\n    return configDsl;\n  };\n\n  AggConfig.prototype.toJSON = function () {\n    var self = this;\n    var params = self.params;\n\n    var outParams = _lodash2.default.transform(self.getAggParams(), function (out, aggParam) {\n      var val = params[aggParam.name];\n\n      // don't serialize undefined/null values\n      if (val == null) return;\n      if (aggParam.serialize) val = aggParam.serialize(val, self);\n      if (val == null) return;\n\n      // to prevent accidental leaking, we will clone all complex values\n      out[aggParam.name] = _lodash2.default.cloneDeep(val);\n    }, {});\n\n    return {\n      id: self.id,\n      enabled: self.enabled,\n      type: self.type && self.type.name,\n      schema: self.schema && self.schema.name,\n      params: outParams\n    };\n  };\n\n  AggConfig.prototype.getAggParams = function () {\n    return [].concat(this.type ? this.type.params.raw : [], _lodash2.default.has(this, 'schema.params') ? this.schema.params.raw : []);\n  };\n\n  AggConfig.prototype.getRequestAggs = function () {\n    if (!this.type) return;\n    return this.type.getRequestAggs(this) || [this];\n  };\n\n  AggConfig.prototype.getResponseAggs = function () {\n    if (!this.type) return;\n    return this.type.getResponseAggs(this) || [this];\n  };\n\n  AggConfig.prototype.getValue = function (bucket) {\n    return this.type.getValue(this, bucket);\n  };\n\n  AggConfig.prototype.getKey = function (bucket, key) {\n    return this.type.getKey(bucket, key, this);\n  };\n\n  AggConfig.prototype.getFieldDisplayName = function () {\n    var field = this.getField();\n    return field ? field.displayName || this.fieldName() : '';\n  };\n\n  AggConfig.prototype.getField = function () {\n    return this.params.field;\n  };\n\n  AggConfig.prototype.makeLabel = function () {\n    if (this.params.customLabel) {\n      return this.params.customLabel;\n    }\n\n    if (!this.type) return '';\n    var pre = _lodash2.default.get(this.vis, 'params.mode') === 'percentage' ? 'Percentage of ' : '';\n    return pre += this.type.makeLabel(this);\n  };\n\n  AggConfig.prototype.getIndexPattern = function () {\n    return this.vis.indexPattern;\n  };\n\n  AggConfig.prototype.getFieldOptions = function () {\n    var fieldParamType = this.type && this.type.params.byName.field;\n\n    if (!fieldParamType || !fieldParamType.getFieldOptions) {\n      return null;\n    }\n\n    return fieldParamType.getFieldOptions(this);\n  };\n\n  AggConfig.prototype.fieldFormatter = function (contentType, defaultFormat) {\n    var format = this.type && this.type.getFormat(this);\n    if (format) return format.getConverterFor(contentType);\n    return this.fieldOwnFormatter(contentType, defaultFormat);\n  };\n\n  AggConfig.prototype.fieldOwnFormatter = function (contentType, defaultFormat) {\n    var field = this.getField();\n    var format = field && field.format;\n    if (!format) format = defaultFormat;\n    if (!format) format = fieldFormats.getDefaultInstance('string');\n    return format.getConverterFor(contentType);\n  };\n\n  AggConfig.prototype.fieldName = function () {\n    var field = this.getField();\n    return field ? field.name : '';\n  };\n\n  AggConfig.prototype.fieldIsTimeField = function () {\n    var timeFieldName = this.vis.indexPattern.timeFieldName;\n    return timeFieldName && this.fieldName() === timeFieldName;\n  };\n\n  return AggConfig;\n}",null]}