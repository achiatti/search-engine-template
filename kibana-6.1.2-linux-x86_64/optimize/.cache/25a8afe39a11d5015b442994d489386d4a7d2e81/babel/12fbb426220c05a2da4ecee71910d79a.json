{"remainingRequest":"/home/vagrant/projects/kibana/build/kibana/node_modules/babel-loader/lib/index.js??ref--6-1!/home/vagrant/projects/kibana/build/kibana/src/ui/public/state_management/state_storage/hashed_item_store.js","dependencies":[{"path":"/home/vagrant/projects/kibana/build/kibana/src/ui/public/state_management/state_storage/hashed_item_store.js","mtime":1515552038000},{"path":"/home/vagrant/projects/kibana/build/kibana/node_modules/cache-loader/dist/cjs.js","mtime":1493198456000},{"path":"/home/vagrant/projects/kibana/build/kibana/node_modules/babel-loader/lib/index.js","mtime":1503096278000}],"contextDependencies":[],"result":["'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.HashedItemStore = undefined;\n\nvar _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }(); /**\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * The HashedItemStore associates JSON objects with states in browser history and persists these\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * objects in sessionStorage. We persist them so that when a tab is closed and re-opened, we can\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * retain access to the state objects referenced by the browser history.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Because there is a limit on how much data we can put into sessionStorage, the HashedItemStore\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * will attempt to remove old items from storage once that limit is reached.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * -------------------------------------------------------------------------------------------------\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Consideration 1: We can't (easily) mirror the browser history\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * If we use letters to indicate a unique state object, and numbers to represent the same state\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * occurring again (due to action by the user), a history could look like this:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Old < - - - - - - - - > New\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * A1 | B1 | C1 | A2 | D1 | E1\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * If the user navigates back to C1 and starts to create new states, persisted history states will\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * become inaccessible:\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Old < - - - - - - - - - - -> New\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * A1 | B1 | C1 | F1 | G1 | H1 | I1  (new history states)\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *                A2 | D1 | E1       (inaccessible persisted history states)\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Theoretically, we could build a mirror of the browser history. When the onpopstate event is\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * dispatched, we could determine whether we have gone back or forward in history. Then, when\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * a new state is persisted, we could delete all of the persisted items which are no longer\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * accessible. (Note that this would require reference-counting so that A isn't removed while D and\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * E are, since A would still have a remaining reference from A1).\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * However, the History API doesn't allow us to read from the history beyond the current state. This\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * means that if a session is restored, we can't rebuild this browser history mirror.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Due to this imperfect implementation, HashedItemStore ignores the possibility of inaccessible\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * history states. In the future, we could implement this history mirror and persist it in\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * sessionStorage too. Then, when restoring a session, we can just retrieve it from sessionStorage.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * -------------------------------------------------------------------------------------------------\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Consideration 2: We can't tell when we've hit the browser history limit\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * Because some of our persisted history states may no longer be referenced by the browser history,\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * and we have no way of knowing which ones, we have no way of knowing whether we've persisted a\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * number of accessible states beyond the browser history length limit.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * More fundamentally, the browser history length limit is a browser implementation detail, so it\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * can change from browser to browser, or over time. Respecting this limit would introduce a lot of\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * (unnecessary?) complexity.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      *\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * For these reasons, HashedItemStore doesn't concern itself with this constraint.\n                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      */\n\nvar _lodash = require('lodash');\n\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nvar HashedItemStore = exports.HashedItemStore = function () {\n\n  /**\n   * HashedItemStore uses objects called indexed items to refer to items that have been persisted\n   * in sessionStorage. An indexed item is shaped {hash, touched}. The touched date is when the item\n   * was last referenced by the browser history.\n   */\n  function HashedItemStore(sessionStorage) {\n    _classCallCheck(this, HashedItemStore);\n\n    this._sessionStorage = sessionStorage;\n\n    // Store indexed items in descending order by touched (oldest first, newest last). We'll use\n    // this to remove older items when we run out of storage space.\n    this._indexedItems = [];\n\n    // Potentially restore a previously persisted index. This happens when\n    // we re-open a closed tab.\n    var persistedItemIndex = this._sessionStorage.getItem(HashedItemStore.PERSISTED_INDEX_KEY);\n    if (persistedItemIndex) {\n      this._indexedItems = (0, _lodash.sortBy)(JSON.parse(persistedItemIndex) || [], 'touched');\n    }\n  }\n\n  _createClass(HashedItemStore, [{\n    key: 'setItem',\n    value: function setItem(hash, item) {\n      var isItemPersisted = this._persistItem(hash, item);\n\n      if (isItemPersisted) {\n        this._touchHash(hash);\n      }\n\n      return isItemPersisted;\n    }\n  }, {\n    key: 'getItem',\n    value: function getItem(hash) {\n      var item = this._sessionStorage.getItem(hash);\n\n      if (item !== null) {\n        this._touchHash(hash);\n      }\n\n      return item;\n    }\n  }, {\n    key: '_getIndexedItem',\n    value: function _getIndexedItem(hash) {\n      return this._indexedItems.find(function (indexedItem) {\n        return indexedItem.hash === hash;\n      });\n    }\n  }, {\n    key: '_persistItem',\n    value: function _persistItem(hash, item) {\n      try {\n        this._sessionStorage.setItem(hash, item);\n        return true;\n      } catch (e) {\n        // If there was an error then we need to make some space for the item.\n        if (this._indexedItems.length === 0) {\n          // If there's nothing left to remove, then we've run out of space and we're trying to\n          // persist too large an item.\n          return false;\n        }\n\n        // We need to try to make some space for the item by removing older items (i.e. items that\n        // haven't been accessed recently).\n        this._removeOldestItem();\n\n        // Try to persist again.\n        return this._persistItem(hash, item);\n      }\n    }\n  }, {\n    key: '_removeOldestItem',\n    value: function _removeOldestItem() {\n      var oldestIndexedItem = this._indexedItems.shift();\n      // Remove oldest item from storage.\n      this._sessionStorage.removeItem(oldestIndexedItem.hash);\n    }\n  }, {\n    key: '_touchHash',\n    value: function _touchHash(hash) {\n      // Touching a hash indicates that it's been used recently, so it won't be the first in line\n      // when we remove items to free up storage space.\n\n      // either get or create an indexedItem\n      var indexedItem = this._getIndexedItem(hash) || { hash: hash };\n\n      // set/update the touched time to now so that it's the \"newest\" item in the index\n      indexedItem.touched = Date.now();\n\n      // ensure that the item is last in the index\n      (0, _lodash.pull)(this._indexedItems, indexedItem);\n      this._indexedItems.push(indexedItem);\n\n      // Regardless of whether this is a new or updated item, we need to persist the index.\n      this._sessionStorage.setItem(HashedItemStore.PERSISTED_INDEX_KEY, JSON.stringify(this._indexedItems));\n    }\n  }]);\n\n  return HashedItemStore;\n}();\n\nHashedItemStore.PERSISTED_INDEX_KEY = 'kbn.hashedItemsIndex.v1';",null]}